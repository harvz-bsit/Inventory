<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#2b6cb0" />
    <title>Carenderia — Realtime DB (Daily Tracker)</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
      body {
        background: #fff;
      }
      .small-muted {
        font-size: 0.85rem;
        color: #666;
      }
      .center {
        text-align: center;
      }
      .expense-item {
        border-bottom: 1px solid #eee;
        padding: 8px 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .list-group-item .btn {
        margin-left: 6px;
      }
    </style>
  </head>
  <body>
    <div class="container py-5 text-center">
      <h3 class="mb-1">Carenderia Daily Tracker (Realtime DB)</h3>
      <div class="card p-3 mb-3">
        <h5 class="mb-0">
          Total Net Income: ₱<span id="totalNetIncome">0.00</span>
        </h5>
      </div>

      <div class="card mx-auto" style="max-width: 480px">
        <div class="card-body">
          <h4 class="card-title">
            Today's Expenses: <span id="balanceDisplay">₱0.00</span>
          </h4>
          <p class="small-muted mb-0" id="todayLabel"></p>
        </div>
      </div>

      <div class="d-flex justify-content-center gap-3 mt-4">
        <button
          class="btn btn-danger"
          data-bs-toggle="modal"
          data-bs-target="#addExpenseModal"
        >
          Add Expense
        </button>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#endDayConfirmModal"
        >
          End the Day
        </button>
        <button
          class="btn btn-secondary"
          data-bs-toggle="modal"
          data-bs-target="#reportsModal"
        >
          Reports
        </button>
      </div>
    </div>

    <!-- ADD/EDIT EXPENSE MODAL -->
    <div class="modal fade" id="addExpenseModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addExpenseModalTitle">Add Expense</h5>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 border-end">
                <div class="mb-2">
                  <label class="form-label">Amount</label>
                  <input
                    id="expenseAmount"
                    type="number"
                    step="0.01"
                    class="form-control"
                    placeholder="e.g. 150.50"
                  />
                </div>
                <div class="mb-2">
                  <label class="form-label">Name</label>
                  <input
                    id="expenseName"
                    type="text"
                    class="form-control"
                    placeholder="e.g. Pork, Rice, Fuel"
                  />
                </div>
                <div class="mb-2">
                  <label class="form-label">Quantity</label>
                  <input
                    id="expenseQuantity"
                    type="text"
                    class="form-control"
                    placeholder="e.g. 2kg"
                  />
                </div>
                <div class="my-3 d-grid gap-2">
                  <button class="btn btn-danger" onclick="saveExpense()">
                    Save Expense
                  </button>
                  <button
                    class="btn btn-outline-secondary"
                    data-bs-dismiss="modal"
                  >
                    Close
                  </button>
                </div>
              </div>
              <div class="col-md-6">
                <h6>Today's Expenses</h6>
                <div
                  id="todayExpenseList"
                  style="max-height: 340px; overflow: auto"
                >
                  <div class="text-muted small">Loading...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- END DAY CONFIRM MODAL -->
    <div class="modal fade" id="endDayConfirmModal" tabindex="-1">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-body center">
            <h5>End the Day?</h5>
            <p class="small-muted">
              This will finalize today's totals and save them for viewing.
            </p>
            <div class="d-flex justify-content-center gap-2 mt-3">
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                Cancel
              </button>
              <button
                class="btn btn-primary"
                data-bs-dismiss="modal"
                data-bs-toggle="modal"
                data-bs-target="#incomeModal"
              >
                Yes
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- INCOME INPUT MODAL -->
    <div class="modal fade" id="incomeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"><h5>Input Today's Total Income</h5></div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">Total Income for today</label>
              <input
                id="incomeTotal"
                type="number"
                step="0.01"
                class="form-control"
                placeholder="e.g. 4500.00"
              />
            </div>
            <div class="small text-muted">
              After saving, all data is stored for viewing in reports.
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button class="btn btn-success" onclick="finishDay()">
              Save & Finalize
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- REPORTS MODAL -->
    <div class="modal fade" id="reportsModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5>Reports</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-lg-4">
                <h6>Saved Reports</h6>
                <div id="savedReportsList" class="list-group">Loading...</div>
              </div>
              <div class="col-lg-8">
                <h6>Chart (Last 14 reports)</h6>
                <canvas id="summaryChart" height="140"></canvas>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- REPORT DETAILS MODAL -->
    <div class="modal fade" id="reportDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="reportDetailsTitle">Report Details</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <p><strong>Date:</strong> <span id="repDate"></span></p>
            <p><strong>Income:</strong> ₱<span id="repIncome">0</span></p>
            <p>
              <strong>Total Expenses:</strong> ₱<span id="repExpenses">0</span>
            </p>
            <p><strong>Net Income:</strong> ₱<span id="repNet">0</span></p>

            <hr />

            <h6>Expenses:</h6>
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Amount</th>
                  <th>Qty</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="repExpensesList"></tbody>
            </table>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Report Modal -->
    <div class="modal fade" id="editReportModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Edit Report</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label>Date</label>
              <input id="editDate" type="text" class="form-control" readonly />
            </div>

            <div class="mb-3">
              <label>Income</label>
              <input id="editIncome" type="number" class="form-control" />
            </div>

            <div class="mb-3">
              <label>Total Expenses</label>
              <input id="editExpenses" type="number" class="form-control" />
            </div>

            <div class="mb-3">
              <label>Net Income</label>
              <input id="editNet" type="number" class="form-control" />
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
            <button class="btn btn-success" onclick="saveReportEdits()">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase modular SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getDatabase,
        ref as dbRef,
        push,
        set,
        onValue,
        get,
        remove,
        update,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDy1Nn1bWD-xZ-_caamokt_4MFV6DCTDdQ",
        authDomain: "inventory-4c29b.firebaseapp.com",
        databaseURL:
          "https://inventory-4c29b-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "inventory-4c29b",
        storageBucket: "inventory-4c29b.firebasestorage.app",
        messagingSenderId: "293543488174",
        appId: "1:293543488174:web:0cbc684fb1244635815b3f",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const expensesRef = dbRef(db, "expenses");
      const incomeRef = dbRef(db, "income");
      const reportsRef = dbRef(db, "reports");

      const PHP = (n) => `₱${Number(n || 0).toFixed(2)}`;
      const todayStr = () => new Date().toISOString().slice(0, 10);

      document.getElementById("todayLabel").innerText = `Date: ${todayStr()}`;

      let editingExpenseId = null; // track current editing

      function escapeHtml(s) {
        if (!s) return "";
        return String(s).replace(
          /[&<>"]/g,
          (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c])
        );
      }

      // Load today's expenses
      function loadExpenses() {
        onValue(expensesRef, (snapshot) => {
          const val = snapshot.val() || {};
          const today = todayStr();
          const entries = [];
          for (const key in val) {
            const e = val[key];
            if (e?.date === today) entries.push({ id: key, ...e });
          }
          entries.sort((a, b) =>
            a.timestamp && b.timestamp
              ? a.timestamp > b.timestamp
                ? 1
                : -1
              : 0
          );
          let total = 0;
          let html = "";
          if (entries.length === 0) {
            html = '<div class="text-muted small">No expenses yet.</div>';
          } else {
            entries.forEach((e) => {
              total += Number(e.amount || 0);
              html += `<div class="expense-item">
                <div>
                  <div><strong>${escapeHtml(e.name || "")}</strong></div>
                  <div class="small-muted">₱${Number(e.amount || 0).toFixed(
                    2
                  )} — Qty: ${escapeHtml(e.quantity || "")}</div>
                </div>
                <div>
                  <button class="btn btn-sm btn-outline-secondary" onclick='editExpense("${
                    e.id
                  }")'>Edit</button>
                  <button class="btn btn-sm btn-outline-danger" onclick='deleteExpense("${
                    e.id
                  }")'>Delete</button>
                </div>
              </div>`;
            });
          }
          document.getElementById("balanceDisplay").innerText = PHP(total);
          document.getElementById("todayExpenseList").innerHTML = html;
        });
      }

      window.addExpense = async function () {
        editingExpenseId = null;
        document.getElementById("addExpenseModalTitle").innerText =
          "Add Expense";
        document.getElementById("expenseAmount").value = "";
        document.getElementById("expenseName").value = "";
        document.getElementById("expenseQuantity").value = "";
      };

      window.saveExpense = async function () {
        const amount = parseFloat(
          document.getElementById("expenseAmount").value
        );
        const name = (
          document.getElementById("expenseName").value || ""
        ).trim();
        const quantity = document.getElementById("expenseQuantity").value || "";

        if (!amount || isNaN(amount) || amount <= 0) {
          alert("Enter a valid amount.");
          return;
        }
        if (!name) {
          alert("Expense name required.");
          return;
        }

        try {
          if (editingExpenseId) {
            const ref = dbRef(db, `expenses/${editingExpenseId}`);
            await update(ref, { amount, name, quantity });
          } else {
            const newRef = push(expensesRef);
            await set(newRef, {
              amount,
              name,
              quantity,
              date: todayStr(),
              timestamp: new Date().toISOString(),
            });
          }
          const modalEl = document.getElementById("addExpenseModal");
          const bs = bootstrap.Modal.getInstance(modalEl);
          if (bs) bs.hide();
          editingExpenseId = null;
          document.getElementById("expenseAmount").value = "";
          document.getElementById("expenseName").value = "";
          document.getElementById("expenseQuantity").value = "";
        } catch (err) {
          console.error(err);
          alert("Failed to save expense: " + err.message);
        }
      };

      window.editExpense = async function (id) {
        const snap = await get(dbRef(db, `expenses/${id}`));
        const data = snap.val();
        if (!data) {
          alert("Expense not found");
          return;
        }
        editingExpenseId = id;
        document.getElementById("addExpenseModalTitle").innerText =
          "Edit Expense";
        document.getElementById("expenseAmount").value = data.amount || "";
        document.getElementById("expenseName").value = data.name || "";
        document.getElementById("expenseQuantity").value = data.quantity || "";
        const modal = new bootstrap.Modal(
          document.getElementById("addExpenseModal")
        );
        modal.show();
      };

      window.deleteExpense = async function (id) {
        if (!confirm("Delete this expense?")) return;
        try {
          await remove(dbRef(db, `expenses/${id}`));
        } catch (err) {
          console.error(err);
          alert("Failed to delete: " + err.message);
        }
      };

      window.finishDay = async function () {
        const incomeInput = parseFloat(
          document.getElementById("incomeTotal").value
        );
        if (!incomeInput || isNaN(incomeInput)) {
          alert("Enter valid income.");
          return;
        }
        const today = todayStr();
        try {
          const snap = await get(expensesRef);
          const data = snap.val() || {};
          const todays = [];
          for (const key in data) {
            const e = data[key];
            if (e?.date === today)
              todays.push({
                id: key,
                amount: Number(e.amount || 0),
                name: e.name || "",
                quantity: e.quantity || "",
                timestamp: e.timestamp || "",
              });
          }
          const totalExpenses = todays.reduce((s, i) => s + (i.amount || 0), 0);
          const net = incomeInput - totalExpenses;
          const summary = {
            date: today,
            income: Number(incomeInput),
            totalExpenses: Number(totalExpenses),
            net: Number(net),
            expenses: todays.map((x) => ({
              name: x.name,
              amount: x.amount,
              quantity: x.quantity,
              timestamp: x.timestamp,
            })),
            createdAt: new Date().toISOString(),
          };
          const reportRef = dbRef(db, `reports/${today}`);
          await set(reportRef, summary);
          // push income
          const inRef = push(incomeRef);
          await set(inRef, {
            amount: Number(incomeInput),
            date: today,
            timestamp: new Date().toISOString(),
          });
          // remove today's expenses
          for (const e of todays) await remove(dbRef(db, `expenses/${e.id}`));
          document.getElementById("incomeTotal").value = "";
          const modalEl = document.getElementById("incomeModal");
          const bs = bootstrap.Modal.getInstance(modalEl);
          if (bs) bs.hide();
          await loadSavedReports();
          alert(`Day finalized. Net Income: ${PHP(net)}`);
        } catch (err) {
          console.error(err);
          alert("Failed to finalize day: " + err.message);
        }
      };

      window.loadSavedReports = async function () {
        try {
          const snap = await get(reportsRef);
          const data = snap.val() || {};
          const list = document.getElementById("savedReportsList");

          list.innerHTML = "";

          const keys = Object.keys(data).sort((a, b) => (a < b ? 1 : -1));

          if (!keys.length) {
            list.innerHTML =
              '<div class="small text-muted">No saved reports yet.</div>';
            return;
          }

          for (const k of keys) {
            const d = data[k];

            const item = document.createElement("button");
            item.className = "list-group-item list-group-item-action";
            item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>${k}</strong>
            <div class="small text-muted">Net: ${PHP(d.net)}</div>
          </div>
          <div>
            <span class="badge bg-primary">View</span>
          </div>
        </div>
      `;

            item.onclick = () => openReportDetails(k, d);

            list.appendChild(item);
          }
        } catch (err) {
          console.error(err);
        }
      };

      //load chart
      const ctx = document.getElementById("summaryChart").getContext("2d");
      const summaryChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Income",
              borderColor: "rgba(54, 162, 235, 1)",
              backgroundColor: "rgba(54, 162, 235, 0.2)",
              fill: true,
              data: [],
            },
            {
              label: "Expenses",
              borderColor: "rgba(255, 99, 132, 1)",
              backgroundColor: "rgba(255, 99, 132, 0.2)",
              fill: true,
              data: [],
            },
            {
              label: "Net",
              borderColor: "rgba(75, 192, 192, 1)",
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              fill: true,
              data: [],
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });
      async function loadChartData() {
        try {
          const snap = await get(reportsRef);
          const data = snap.val() || {};
          const entries = Object.values(data).sort((a, b) =>
            a.date > b.date ? 1 : -1
          );
          const last14 = entries.slice(-14);
          summaryChart.data.labels = last14.map((e) => e.date);
          summaryChart.data.datasets[0].data = last14.map((e) => e.income);
          summaryChart.data.datasets[1].data = last14.map(
            (e) => e.totalExpenses
          );
          summaryChart.data.datasets[2].data = last14.map((e) => e.net);
          summaryChart.update();
        } catch (err) {
          console.error(err);
        }
      }

      window.openReportDetails = function (dateKey, reportData) {
        document.getElementById("reportDetailsTitle").innerText =
          "Report – " + dateKey;

        document.getElementById("repDate").innerText = dateKey;
        document.getElementById("repIncome").innerText = Number(
          reportData.income || 0
        ).toFixed(2);
        document.getElementById("repExpenses").innerText = Number(
          reportData.totalExpenses || 0
        ).toFixed(2);
        document.getElementById("repNet").innerText = Number(
          reportData.net || 0
        ).toFixed(2);

        const table = document.getElementById("repExpensesList");
        table.innerHTML = "";

        if (reportData.expenses && Array.isArray(reportData.expenses)) {
          reportData.expenses.forEach((e) => {
            table.innerHTML += `
        <tr>
          <td>${escapeHtml(e.name)}</td>
          <td>₱${Number(e.amount).toFixed(2)}</td>
          <td>${escapeHtml(e.quantity)}</td>
          <td>${e.timestamp ? e.timestamp.slice(11, 16) : ""}</td>
        </tr>
      `;
          });
        }

        const modal = new bootstrap.Modal(
          document.getElementById("reportDetailsModal")
        );
        modal.show();
      };

      async function loadTotalNetIncome() {
        try {
          const snap = await get(reportsRef);
          const data = snap.val() || {};

          let totalNet = 0;

          const keys = Object.keys(data);

          keys.forEach((k) => {
            const report = data[k];
            totalNet += Number(report.net || 0);
          });

          document.getElementById("totalNetIncome").innerText =
            totalNet.toFixed(2);
        } catch (err) {
          console.error("Error loading total net income:", err);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadTotalNetIncome();
      });

      loadChartData();
      loadExpenses();
      loadSavedReports();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").then(() => {
          console.log("Service Worker registered");
        });
      }
    </script>
  </body>
</html>
